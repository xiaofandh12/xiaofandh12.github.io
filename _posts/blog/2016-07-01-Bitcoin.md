---
layout: post
title: 比特币的基本原理 -- 数十年来密码学、分布式系统和货币研究的巅峰之作
description: 比特币, Bitcoin, 区块链, Blockchain
category: blog
---
## 写在前面

参考资料列在了最后面，本文的内容基本都来自于这些参考资料。如果觉得看不懂，可以直接看这些参考资料(尤其是前面几篇文章)，写得都蛮不错的。

## 目录

* 支付手段的演变
* 比特币的基本原理
	* 概述
	* 总账本，即区块链
	* 产生交易
	* 收集交易，产生区块
	* 确认交易，产生区块链
	* 比特币的所有权问题
	* 比特币的双重支付问题
* 比特币的问题
* 其它方面
* 参考资料

## 支付手段的演变

从古至今支付手段都是处于不断的发展和变化之中，大致上经历了以物易物、实物货币(黄金)、符号货币(人民币、美元等)、中央系统虚拟货币(银行、支付宝、微信支付等)、分布式系统虚拟货币几个阶段，其中比特币便是分布式系统虚拟货币的开山之作。一般来说，自我们人类存在以来，大致可以按照上古时代、农业时代、工业时代、信息时代来划分，其实当从货币支付角度来看的时候，每个时代都伴随着新的支付手段的产生，而比特币这种新型的分布式系统虚拟货币的诞生，是不是意味着下一个时代的诞生呢？

货币必须要具备一些基本的属性，比如要稀少、珍贵、便携，产生速度不易过快或过慢，最好是可控的，只有在具备了这些基本属性之后，才有可能被广泛的接收，使得货币在人类的各种交易中发挥其作用。

货币具备了一些基本属性之后，还必须得有手段保证其发行量、防伪、购买力。实物货币是靠天然的产量限制货币的发行量，靠天然的化学属性进行防伪，靠天然的珍稀性保证购买力；符号货币靠中央银行的领导和经济专家决定发行多少货币，靠不断的提高制作工艺和更高级的验钞机进行货币防伪，靠国家力量来保证购买力；中央系统虚拟货币靠中央银行的领导和经济专家决定发行多少货币，靠中央系统的总账本记录所有交易进行货币防伪，靠国家力量来保证购买力；分布式系统虚拟货币靠指定总量来决定发行多少货币，靠区块的产生速度来控制货币的发行速度，靠分布式系统的总账本(区块链)记录所有交易以及密码学来进行货币防伪，靠其天然的珍稀性保证购买力。比特币能否被广泛的接收，进而成为一种有效的分布式系统虚拟货币，还有待长期的观察和改进，不过它绝对是一次伟大而重要的尝试。

## 比特币的基本原理

### 概述

中本聪在2008年发表论文"A peer-to-peer electronic cash system"，标志着比特币的诞生，没过多久中本聪又编写了bitcoin core(比特币核心)，产生了第一个区块和第一笔交易。中本聪在第一个交易中，写下了"The Times 03/Jan/2009 Chancellor on brink of second bailout for banks(2009年1月3日，财政大臣正站在第二轮救助银行业的边缘)"，一方面标志着比特币在这一天正式开始运行，另一方面讽刺了当前货币制度的不合理性。在发表了论文和编写了比特币核心，并使系统稳定运行了一段时间后，中本聪逐渐淡出公众视野，到现在也不知道中本聪真名叫什么，到底是谁。

货币的一切都是在保证交易的正常进行，在中央系统虚拟货币中，我们之所以可以正常的进行交易，是因为我们在中央系统有一个账号及对应的密码，另外中央系统中会记录每个账号所有的交易信息。在一定程度上来说，比特币也类似于中央系统虚拟货币，只是比特币是把所有的交易记录在区块链中，而区块链又是完全公开的，只要满足一定的条件谁都可以在区块链中记录下交易。

总结起来，比特币需要解决的就是两个问题：比特币的所有权问题和比特币的双重支付问题。在交易中来分析，比特币的所有权问题就是在交易的时候有没有足够的比特币以及使用的比特币确实是属于你的，比特币的双重支付问题就是要保证已经使用过的比特币不会再被使用。我们要明白一点，比特币并不是一张纸或是某个具体的数字，一个人拥有多少比特币是根据你在总账本(区块链)中的交易记录来查询的，其实在中央系统虚拟货币中也应该是这么做的。

再来分析一下，比特币的两个问题在中央系统虚拟货币中是怎么解决的。所有权问题，因为我们在中央系统中有账号和密码，所以根据提供的账号就可以查询出该账号的所有交易信息，再根据这些交易信息计算出一些统计信息，这些统计信息中就包括该账号的余额，当进行一笔交易时，只要余额足够就可以成功交易。双重支付问题在中央系统虚拟货币中是不存在的，因为中央系统的账本只有中央系统可以书写。

在分布式系统中账本(区块链，记录了所有的交易信息)是完全公开的，这个特性引起了上述两个问题，而比特币以创造性的方法成功的解决了这两个问题。完全公开的账本(区块链)也带来了很多好处，比如我们的交易不再依赖某个中央系统，谁都可以进行审计等等。

数字货币的研究由来已久，所以所有权问题并不是中本聪在论文中主要考虑的问题，该论文的最大的创新之处，在于完美的解决了双重支付问题。

### 总账本，即区块链

我们可以把区块链理解为一个数据结构，而比特币是使用该数据结构实现中央系统虚拟货币的一个算法。

交易是指某个比特币地址向另一个比特币地址支付了某数量的比特币；区块是指包含区块头和多个交易信息的一个结构体；区块链是指区块链接而成的一个链表。我们可以把区块链理解为一个链表，这个链表中的每个节点是一个区块，区块中又包含了一定数量的交易信息。

区块的产生速度是在算法中通过调整难度来控制的，基本上是每十分钟产生一个有效区块，该区块中包含了这段时间或更早时间的一些交易信息，每两个星期会根据区块产生的速度来调整难度，以保证每十分钟产生一个有效区块的目标。我们可以在网站[Blockchain info](https://blockchain.info)上来查询区块链中的信息，如某个交易的信息，某个区块的信息，某个比特币地址的所有交易，当前的区块链长度等等，可以看到区块链确确实实是完全公开的。

### 产生交易

如果我们不想到网站上去查询信息、或是要发起一笔交易、或是要接收比特币等，都需要在本地安装软件，最好最全最权威的应该就是比特币核心。

在windows下安装比特币核心，可以到到比特币的官方网站[http://bitcoin.org](http://bitcoin.org)上下载，如下图：

![bitcoin core windows](/images/2016-07-01-Bitcoin/bitcoincore2.png)

下载完了，就像普通的安装软件即可，安装完成要经历的一个同步区块链的过程，区块链的同步过程根据网速的不同，时间可能会需要好几天。同步完成后，就可以正常的使用比特币核心了，如下图。比特币核心的使用大概就是加密钱包，备份钱包，接收比特币，支付比特币，终端的使用几个方面。钱包记录了你所有的私钥，可以用来接收/支付比特币，很多的比特币软件和基本所有的手机比特币应用都只有钱包功能。通过终端提供的很多命令，我们可以查询到更多的信息，实现更多的功能。

![bitcoin core windows](/images/2016-07-01-Bitcoin/bitcoincore1.png)

在centos 7(linux类)下安装比特币的核心大致要使用到下面几个命令，很多linux下的程序都是通过这种方式来安装的(即所谓的源码安装):

	git clone https://github.com/bitcoin/bitcoin.git
	必备库安装(参考文档./bitcoin/doc/build-unix.md)
	./autogen.sh
	./configure
	make
	make install 

安装完成后使用以下命令来启动比特币核心：
	
	bitcoind -txindex --daemon	
	
启动完成后，也需要同步区块链，可以通过以下命令来查询同步的过程，bitcoin-cli是比特币核心的客户端，可以实现比特币核心提供的所有功能。

	bitcoin-cli getinfo
	
可以通过以下命令来查询bitcoin-cli提供了哪些功能：

	bitcoin-cli help

下图使用bitcoin-cli获取第21个区块(创世区块编号为0)的信息。

![get block info](/images/2016-07-01-Bitcoin/getblock.png)

下图使用bitcoin-cli来获取第21个区块中唯一的一条交易的信息。

![get raw transaction](/images/2016-07-01-Bitcoin/getrawtransaction.png)

下图是交易这个结构中包含的具体字段，对于理解比特币的基本原理来说，最重要额是vin和vout；vin是交易的输入，也就是用于当前交易的比特币来自于哪里，vout是交易的输出，也就是当前交易的比特币支付多少给谁；一个交易可以有多个vin，多个vout。

![transaction](/images/2016-07-01-Bitcoin/transaction.png)

我们可以用现实生活中的一个例子来理解这个问题，比如我们平时买东西，若需要支付给商家8元钱，那我们会在钱包里面找到两个5元(vin)，两个5元共10元，其中8元用来支付给商家(vout)，另外2元会支付给自己(vout)。在现实生活中，我们是把10元先给商家，商家再把2元通过找零的方式退还给我们，但其实这个过程也可以理解为我们是把8元给了商家，把2元给了自己，因为在比特币中不存在找零的过程，所以实现起来的时候都是一部分给商家，一部分给自己。那为什么不正好给商家数量正好的比特币呢？因为我们这里的vin实际上是前面某个交易的vout，就像我们钱包里的那两个5元钱如果追根溯源也都是来自于前面某次别人给我们的，而前面某个交易的vout中有多少比特币的数量是一定的，有的时候一个vout不够支付，我们需要把前面好几个交易的vout组合起来支付，也就像这里我们需要用两个5元来组合为10元一样。


在上面交易的数据结构中，我们可以看到vin中有txid，vout这两个字段，它们就指明了当前交易的比特币来源，即txid中编号为vout的比特币。这里一定要理解区块链中记录的信息就是交易信息，而我们用于当前交易的比特币实际上是来自前面某个交易的收入，那这样追根溯源之后我们会发现这些比特币最终都是来自于某区块的coinbase交易，coinbase交易就是矿工生成了一个有效区块后，在区块中加入的一条支付给自己的交易，这是矿工挖矿的收益来源之一(另一来源是交易费，每笔交易都会收取少许的交易费)，也是目前矿工挖矿最主要的收益来源，coinbase交易也是产生比特币的唯一方式。矿工挖矿生成有效区块，在其中加入coinbase交易，最初coinbase交易中支付给矿工自己的数量为50个比特币，以后是大概每4年减半，因为区块的生成速度(每10分钟一个)，每个区块产生的比特币(coinbase交易)都是可控制的，所以最终会产生多少个比特币，在什么时候产生最后的比特币都是可以预测的。

我们理解了交易中的的vin是前面某一个交易的vout后，我们可以来定义一个概念，即UTXO(Unspent Transaction Output)，也就是未支付的vout，下图中展示了UTXO。如果你能让别人相信你拥有该vout，那你就可以使用该vout来发起一笔交易。

![Unspent Transaction Output](/xiaofandh12.github.io/images/2016-07-01-Bitcoin/utxo.png)

到这里，我们可以重新来理解一下比特币的所有权问题，所谓的所有权问题也就是能够证明你拥有某个UTXO的问题。那这是怎么来证明的呢？就需要使用到vin和vout中的其它字段，也就是vin中的scriptSig字段，以及vin中指明的前面某个交易的vout中的scriptPubKey。注意这里是指vin中指明的前面某个交易的vout，和当前交易的vout没有关系，当前交易的vout会成为别的交易的vin，但是和当前交易vin中指明的vout直接没有任何关系。

### 收集交易，产生区块

比特币使用的是p2p网络，一个节点可以和多个节点相连接，交换信息。当一个节点产生了一笔交易后，它会把该交易传给它所连接的其它节点，当其它节点收到这笔交易后，首先会验证这笔交易，如果验证通过就会转发该交易，如果验证失败就是丢弃该交易。

普通的节点不会把交易记录下来，但是矿工节点会把交易记录下来，但需要新产生一个区块时，它就会把还没有包含在任何一个区块中的交易，包含在自己要新产生的区块中。

区块的数据结构如下所示，其中重要的是hash,merkelroot,tx,nonce,nextblockhash，hash是指前一个区块的hash值，merkelroot是区块中的交易形成的merkle tree的根节点，nonce值是为了生成有效的nextblockhash而准备的，nextblockhash是下一个区块的hash值。nextblockhash是根据区块中的hash, merkleroot,nonce生成的，它必须要满足一定的条件，即前面多少个字符为0，hash算法是一定的，可以通过改变nonce值来达到这个目的，需要为0的字符越多难度也就越大，所谓的矿工挖矿也就是不断的调整nonce值，以生成满足条件的nextblockhash。

![generator block](/images/2016-07-01-Bitcoin/blockgener.png)

矿工收集交易信息，是为了自己的收益，矿工的收益来自于产生有效区块时，区块中的coinbase交易，coinbase交易包括系统的奖励和区块中交易的交易费。前面说到nextblockhas是通过hash算法计算hash,merkelroot,nonce而得到的，其中只有nonce可变，hash值是前面一个区块的nextblockhahs，那merkleroot是怎么产生的呢？它为什么不可变呢？

merkelroot是交易组成的merkle tree的根节点，merkel tree的结构如下图。假如其中f1、 f2、 f3、 f4是4笔交易(奇数交易的时候，复制最后一条组成merkle tree)，分别对f1、 f2、 f3、 f4求hash值得到h1、 h2、 h3、 h4，再对h1、h2求hash值得到h5，h3、h4求hash值得到h6，最后最h5、h6求hash值得到h7，那么h7也就是merkel tree的根节点了。merkle tree有一个重要特点，就是任何一个叶子节点的细微变化都会导致根节点的面目全非，反过来我们也可以说merkle root的根节点一样，那么它们的叶子节点也就一样。因此我们可以知道，只要区块中某个交易发生了细微变化，都会反映到merkleroot中。

![merkle tree](/images/2016-07-01-Bitcoin/merkletree.png)

### 确认交易，产生区块链

区块链是区块的链表，其结构如下面的示意图所示：

![block chain](/images/2016-07-01-Bitcoin/blockchain.png)

矿工的工作就是不断的收集交易，产生有效的区块，获取coinbase交易中的收益。矿工通过工作量证明机制(proof-of-work)，也就是不断的调整当前区块的nonce值，使生成的nextblockhash满足难度要求，难度要求也就是指生成的hash值前面有多少个零，零越多难度越大。矿工越多，难度就会相应加大；矿工减少，难度就会相应减小；目标就是使得每隔10分钟产生一个有效区块，难度会每隔两周调整一次。

当矿工生成了一个有效区块后，马上会将该区块传递到其它矿工处，并开始生成下一个区块并验证工作，收到区块的矿工会马上停下手中的工作，验证区块的有效性，一旦验证通过便会马上开始生成下一个区块并开始验证工作。下图是一个具有多种节点类型、网关及协议的扩展比特币网络。矿池是由多个矿工组成的，它们的结合是为了降低风险，然后按比例分得奖励。关于这幅图的详细讲解可以看《精通比特币》。
![p2p network](/images/2016-07-01-Bitcoin/p2pnetwork.png)

下面我们来分析一下，全网是怎么样保持都在同一个主区块链上进行工作，使得区块链中的信息保持统一的。首先，如下图所示，加入现在网络中所有节点的区块链都处于区块P，并在此基础上开始生成下一个区块链的工作。
![main chain](/images/2016-07-01-Bitcoin/mainchain1.png)

如下图所示，当某个时候若有两个节点都生成了有效的区块，于是它们开始向网络中传播，红色部分和绿色部分表示它们开始向网络中传播自己收到的有效区块。
![main chain](/images/2016-07-01-Bitcoin/mainchain2.png)

如下图所示，红色部分和绿色部分都在区块P的基础上收到了各自的下一个有效区块，即区块A和区块B，这个时候两个区块链都是同样长的，所以他们继续在各自的区块链上往下生成有效区块。
![main chain](/images/2016-07-01-Bitcoin/mainchain3.png)

如下图所示，当某个时刻又有一个节点在区块B的基础上，又找到了有效的区块，并开始向网络中传播。
![main chain](/images/2016-07-01-Bitcoin/mainchain4.png)

如下图所示，原来在区块A上工作的节点收到粉色的区块后，发现这个区块不是在区块A上工作的，但却更长，所以就会抛弃掉区块A这条链，而转到区块B这条链上来；原来在区块B上工作的节点收到粉色的区块后，发现这个区块就是在区块B上工作的，就会很高兴，知道有节点已经在自己的区块B上生成了一个有效区块，这个时候区块B上的交易也就是有了一次确认，一般有了六次确认后，就可以确认该交易成功了。
![main chain](/images/2016-07-01-Bitcoin/mainchain5.png)

### 比特币的所有权问题

![transaction](/images/2016-07-01-Bitcoin/transaction.png)

![private key, public key and bitcoin address](/images/2016-07-01-Bitcoin/pubandprivkey.png)

![P2PKH](/images/2016-07-01-Bitcoin/p2pkh.png)

![P2PKH validation](/images/2016-07-01-Bitcoin/p2pkhvalidation.png)

### 比特币的双重支付问题

![block chain](/images/2016-07-01-Bitcoin/blockchain.png)


## 比特币的问题

* 通货紧缩

理解完比特币的基本原理后，它的问题最直观的就是有可能会产生通货紧缩问题。比特币的总量为2100万，总量本来是很容易更改的，但是基本不可能能够更改，因为投入了大量资源的矿工不会同意。通货紧缩是指钱少于商品，通货膨胀是指钱多于商品，比特币的总量固定，而商品数量是会不断增加的，所以出现通货紧缩的概率是很大的，但不是一定的。

![cumulative BTC in circulation](/images/2016-07-01-Bitcoin/chanliang.png)

* 矿工的奖励

矿工目前的奖励，来自于系统奖励和交易费；随着系统奖励的越来越低，到最后会为0，矿工挖矿是会消耗很多成本的，为维持盈利，矿工会不会收取更高额的交易费。

花旗银行的一篇报告中写道“工作量证明会产生大量的能源成本，我们认为最终这些成本会产生大量的能源成本，我们认为最终这些成本将会转化为高交易费，由用户承担，这样就造成比特币的成本要比中心化网络更加昂贵。”，我觉得蛮有道理。

* 矿工是不是在干一件毫无意义的事儿

矿工所做的一件事儿就是通过hash算法调整nonce计算满足难度要求的hash值，这件事儿本身确实是毫无意义的，但是如果比特币是有意义的，那么矿工维持了比特币的正常运行，它干的事儿自然也就是有意义的。

* 矿池会不会控制比特币，而是比特币的去中心化失去意义

目前矿工单独挖矿的情况已经很少了，都会加入到某个矿池中，组成更大的算力，平分矿池的奖励。矿池会把当前的难度降低一些，比如本来是要求前10个字符为0，矿池就会要求它的矿工提交前8个字符为0的结果即可，这样一方面是作为如何在矿工之间分配奖励的依据，另一方面因为矿工提交的是满足前8个字符为0的结果，那么在这些结果当中很有可能有满足前10个字符为0的情况。

目前的区块由大矿池挖出来的概率很大，下图是各个矿池产生有效区块的比例。

![mining](/images/2016-07-01-Bitcoin/miningdis.png)

由矿池这种形式的出现就会出现一个问题，那就是矿池会成为新的中心，而使比特币的去中心化失去意义，这样的趋势感觉是越来越明显，有一种P2PPool的矿池协议就是针对这个问题的一个解决方案。

## 其它方面

* 比特币的BIP，权益证明，智能合约

在理解完了比特币的基本原理后，需要继续研究比特币的BIP(即比特币的改进方案)，替代工作量证明机制的权益证明，以及智能合约。

比特币的支付对象为一个比特币地址(或脚本)，智能合约是说可以把某种虚拟货币支付给一个程序(也就是智能合约)，智能合约的代表应该是以太坊了。

* 以太坊

下图是Slock.it利用DAO实现的Airbnb的功能，最近DAO事件闹得挺凶，说明以太坊还有很长的路要走。

![DAO](/images/2016-07-01-Bitcoin/dao.png)

* 莱特币，狗狗币，瑞波币

这些币都是对比特币进行了简单的改进，比如换一种hash算法，调整下货币总量和产生速度等。

* 交易平台

交易平台是指比特币和别的货币交易的平台，比如可以用比特币换人民币，当然也可以用人民币买比特币。

我个人在BTCC上花了100元钱买了0.0229个比特币，具体的过程如下：
	
* 在BTCC上注册账号
* 通过网银向BTCC充值（不知道为什么支付宝转账没成功）
* 在BTCC的交易所里购买比特币
* 提现到币看比特币的钱包里（币看比特币是一个手机应用）

下图实在OKCoin上截的图，可以看到比特币、莱特币的价格。
![Trade](/images/2016-07-01-Bitcoin/trade.png)

下图是币看比特币的钱包界面。
![bikan](/images/2016-07-01-Bitcoin/bitcoinbikan.png)

* 未来货币的状态

实物、符号、中央系统虚拟货币和分布式系统货币并存，但是拥有各自的交易场景，而随着支付方式的多样化，将会刺激产生更多的交易，刺激更多的科技、金融创新。

* Baas

Baas是指Blockchain-as-a-service，即区块链即服务，这是我自IAAS，PAAS，SAAS，CAAS之后听说的又一个云计算的概念，希望它能早日发挥作用。

## 参考资料

* [A peer-to-peer electronic cash system](https://bitcoin.org/bitcoin.pdf)
* [精通比特币](http://zhibimo.com/read/wang-miao/mastering-bitcoin/index.html)
* [Bitcoin Core Developer Documentation](https://bitcoin.org/en/developer-documentation
)
* [Bitcoin Core Developer Guide](https://bitcoin.org/en/developer-guide)
* [A gentle introduction to bitcoin](https://bitsonblocks.net/2015/09/01/a-gentle-introduction-to-bitcoin/)
* [A gentle introduction to bitcoin mining](https://bitsonblocks.net/2015/09/21/a-gentle-introduction-to-bitcoin-mining/)
* [A gentle introduction to blockchain technology](https://bitsonblocks.net/2015/09/09/a-gentle-introduction-to-blockchain-technology/)
* [A gentle introduction to digital tokens](https://bitsonblocks.net/2015/09/28/a-gentle-introduction-to-digital-tokens/)
* [A gentle introduction to immutability of blockchain](https://bitsonblocks.net/2016/02/29/a-gentle-introduction-to-immutability-of-blockchains/)
* [一个故事告诉你比特币的原理及运行机制](http://blog.codinglabs.org/articles/bitcoin-mechanism-make-easy.html)
* [区块链—比特币的灵魂，下一个风口](http://36kr.com/p/5041713.html)
* [重重迷雾包裹下的区块链技术](http://chainb.com/?P=Cont&id=1228)
* [比特币区块链开发由浅入深指南（一）](http://www.8btc.com/blockchain_develope_lesson_1)
* [比特币区块链开发由浅入深指南（二）](http://www.8btc.com/ppkpub_blockchain_develope_lesson_2)
* [Github Bitcoin](https://github.com/bitcoin/bitcoin
Source Code Documentation: https://dev.visucore.com/bitcoin/doxygen/)
* [Bitcoin wiki](https://en.bitcoin.it/wiki/Main_Page)
* [bitcoin talk](https://bitcointalk.org)
* [BTCChina](https://www.btcc.com)
* [Blockchain Info](https://blockchain.info)
* [合约币](http://counterparty.io)
* [以太坊](http://ethfans.org)
* 手机应用 -- OKCoin
* 手机应用 -- 币看比特币
* 微信公众号：区块链铅笔Blockchain(chainbcom)
